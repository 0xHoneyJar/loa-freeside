# E2E Test Infrastructure — Redis + PostgreSQL
# Sprint 1, Task 1.3: Agent Gateway E2E Tests
#
# Base images pinned by digest per AC-2.11.
# Usage: docker compose -f tests/e2e/docker-compose.e2e.yml up -d
#
# @see SDD §3.2.1 E2E Test Infrastructure

services:
  redis-e2e:
    # Redis 7.2 — pinned by digest for reproducibility
    image: redis:7.2@sha256:e422889e156ebea83856b6ff973bfe0c86bce867d80def228044eeecf925592b
    ports:
      - "6399:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 5s
    tmpfs:
      - /data

  postgres-e2e:
    # PostgreSQL 15 — pinned by digest for reproducibility
    image: postgres:15@sha256:68b988a164c8bdf0752fa7a4ae2d4b34a058a21c6327e3b0a80f3c6f4a6b1c4a
    ports:
      - "5499:5432"
    environment:
      POSTGRES_USER: arrakis_e2e
      POSTGRES_PASSWORD: arrakis_e2e
      POSTGRES_DB: arrakis_e2e
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arrakis_e2e"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 5s
    tmpfs:
      - /var/lib/postgresql/data
