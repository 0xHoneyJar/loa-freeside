# Staging Environment Setup Guide

This guide walks through setting up the staging environment for Arrakis.

## Prerequisites

- AWS CLI v2 configured with appropriate permissions
- Terraform >= 1.6.0
- Access to AWS account 891376933289
- ACM certificate for `staging.api.arrakis.community` (or wildcard `*.api.arrakis.community`)

## Step 1: Create Staging Secrets

Before deploying infrastructure, create the required secrets in AWS Secrets Manager.

### App Config Secret

```bash
aws secretsmanager create-secret \
  --name arrakis-staging/app-config \
  --description "Staging application configuration" \
  --secret-string "$(cat <<'EOF'
{
  "BGT_ADDRESS": "0x656b95E550C07a9ffe548bd4085c72418Ceb1dba",
  "BERACHAIN_RPC_URLS": "https://rpc.berachain.com",
  "TRIGGER_PROJECT_ID": "your-staging-trigger-project",
  "TRIGGER_SECRET_KEY": "your-staging-trigger-secret",
  "DISCORD_BOT_TOKEN": "your-staging-discord-token",
  "DISCORD_GUILD_ID": "your-staging-guild-id",
  "DISCORD_CHANNEL_THE_DOOR": "staging-channel-id",
  "DISCORD_CHANNEL_CENSUS": "staging-channel-id",
  "DISCORD_ROLE_NAIB": "staging-role-id",
  "DISCORD_ROLE_FEDAYKIN": "staging-role-id",
  "ADMIN_API_KEYS": "$2b$10$your-staging-bcrypt-hash"
}
EOF
)"
```

### Secrets Checklist

| Secret | Path | Required Keys |
|--------|------|---------------|
| App Config | `arrakis-staging/app-config` | BGT_ADDRESS, BERACHAIN_RPC_URLS, TRIGGER_*, DISCORD_*, ADMIN_API_KEYS |
| Vault Token | `arrakis-staging/vault-token` | (single value) |

**Note**: DB and Redis credentials are auto-generated by Terraform.

## Step 2: Deploy Infrastructure

```bash
cd infrastructure/terraform

# Initialize with staging backend
terraform init -backend-config=environments/staging/backend.tfvars -reconfigure

# Set Vault token (if using Vault)
export TF_VAR_vault_token="your-staging-vault-token"

# Plan
terraform plan -var-file=environments/staging/terraform.tfvars -out=staging.tfplan

# Review the plan carefully!
terraform show staging.tfplan

# Apply
terraform apply staging.tfplan

# Save outputs
terraform output > staging-outputs.txt
```

## Step 3: Verify Deployment

```bash
# Check ECS services
aws ecs describe-services \
  --cluster arrakis-staging-cluster \
  --services arrakis-staging-api arrakis-staging-worker \
  --query 'services[].{name:serviceName,status:status,running:runningCount}'

# Check health endpoint (after DNS is configured)
curl https://staging.api.arrakis.community/health
```

## Step 4: Configure DNS

Add a CNAME record for `staging.api.arrakis.community` pointing to the staging ALB DNS name.

```bash
# Get ALB DNS
aws elbv2 describe-load-balancers \
  --names arrakis-staging-alb \
  --query 'LoadBalancers[0].DNSName' \
  --output text
```

## Step 5: Configure GitHub Actions (Optional)

If using separate AWS credentials for staging:

1. Go to repository Settings → Secrets and variables → Actions
2. Add environment-specific secrets:
   - `STAGING_AWS_ACCESS_KEY_ID`
   - `STAGING_AWS_SECRET_ACCESS_KEY`
3. Update `deploy-staging.yml` to use these secrets

## Secrets Reference

### Required Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `BGT_ADDRESS` | BGT token contract address | `0x656b95E550C07a9ffe548bd4085c72418Ceb1dba` |
| `BERACHAIN_RPC_URLS` | RPC endpoints (comma-separated) | `https://rpc.berachain.com` |
| `TRIGGER_PROJECT_ID` | Trigger.dev project ID | `proj_xxx` |
| `TRIGGER_SECRET_KEY` | Trigger.dev secret key | `tr_xxx` |
| `DISCORD_BOT_TOKEN` | Discord bot token | `MTxx...` |
| `DISCORD_GUILD_ID` | Discord server ID | `123456789` |
| `DISCORD_CHANNEL_THE_DOOR` | Welcome channel ID | `123456789` |
| `DISCORD_CHANNEL_CENSUS` | Census channel ID | `123456789` |
| `DISCORD_ROLE_NAIB` | Naib role ID | `123456789` |
| `DISCORD_ROLE_FEDAYKIN` | Fedaykin role ID | `123456789` |
| `ADMIN_API_KEYS` | Bcrypt-hashed API keys (comma-separated) | `$2b$10$xxx` |

### Staging vs Production Considerations

| Aspect | Staging | Production |
|--------|---------|------------|
| Discord Server | Separate test server | Main community server |
| Trigger.dev | Staging project | Production project |
| RPC Endpoints | Can use public RPCs | Should use private RPCs |
| API Keys | Test keys only | Production keys |

## Troubleshooting

### ECS Tasks Not Starting

```bash
# Check service events
aws ecs describe-services \
  --cluster arrakis-staging-cluster \
  --services arrakis-staging-api \
  --query 'services[0].events[:5]'

# Check task stopped reason
aws ecs describe-tasks \
  --cluster arrakis-staging-cluster \
  --tasks $(aws ecs list-tasks --cluster arrakis-staging-cluster --service-name arrakis-staging-api --query 'taskArns[0]' --output text) \
  --query 'tasks[0].stoppedReason'

# Check logs
aws logs tail /ecs/arrakis-staging/api --since 30m
```

### Secrets Not Found

```bash
# List all staging secrets
aws secretsmanager list-secrets \
  --filter Key=name,Values=arrakis-staging

# Check specific secret exists
aws secretsmanager describe-secret \
  --secret-id arrakis-staging/app-config
```

### Database Connection Issues

```bash
# Check RDS status
aws rds describe-db-instances \
  --db-instance-identifier arrakis-staging-postgres \
  --query 'DBInstances[0].{status:DBInstanceStatus,endpoint:Endpoint.Address}'
```

## Cleanup

To destroy staging infrastructure:

```bash
cd infrastructure/terraform
terraform init -backend-config=environments/staging/backend.tfvars -reconfigure
terraform destroy -var-file=environments/staging/terraform.tfvars
```

**Warning**: This will delete all staging resources including the database!
