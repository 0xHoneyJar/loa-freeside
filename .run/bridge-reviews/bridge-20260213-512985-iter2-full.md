# Bridge Review â€” Iteration 2

**Project**: Arrakis Gateway
**Scope**: Fixes for BB60 iteration 1 findings (BF-1 through BF-6)
**Reviewer**: Bridgebuilder
**Date**: 2026-02-13
**Iteration**: 2 of N

---

## Executive Summary

This iteration addressed 7 of the 18 findings from iteration 1, targeting 2 HIGH and 5 MEDIUM items. Five of the six fixes are well-executed: the GuildCreate logging (BF-1), the circuit breaker (BF-2), the E2E gating (BF-3), the CI services (BF-4), and the guild-count documentation (BF-6) are all correct and complete.

However, the `token` to `interaction_token` rename (BF-5) introduced a **breaking wire-format change** without updating the downstream consumer. The worker's `CommandNatsConsumer` still reads `payload.data.token`, which will now be `undefined` after this change ships. This is a new HIGH finding that must be resolved before merge.

**Iteration 2 Score**: 68 / 100 (up from 26, blocked by one new HIGH)

---

## Fix-by-Fix Analysis

### BF-1: GuildCreate Serialization Logging (was BB60-2, HIGH)

**File**: `apps/gateway/src/events/serialize.rs` lines 51-55

The old code used `.unwrap_or(Value::Null)` which silently swallowed serialization failures. The fix replaces this with `.unwrap_or_else(|e| { warn!(...); Value::Null })`, which logs the error with structured fields (`shard_id`, `error`) before falling back.

**Verdict**: Correct and complete. The structured tracing fields integrate well with the existing observability setup. The fallback behavior is preserved (downstream still receives a valid `GatewayEvent` with null data), which is the right call for a non-critical event payload.

### BF-2: Consecutive Error Circuit Breaker (was BB60-7, HIGH)

**File**: `apps/gateway/src/shard/pool.rs` lines 155-182

The implementation is clean:
- `MAX_CONSECUTIVE_ERRORS` is a const (10), visible and greppable
- Counter resets on any successful event (`consecutive_errors = 0`)
- The `consecutive` field is emitted in every warn/error log, enabling alerting
- Shard transitions to `Dead` state and returns `Err`, triggering the pool's restart logic

The placement is correct: the circuit breaker check sits *after* the existing `Reconnect` fatal check, so reconnect failures still fast-path. The `continue` on non-fatal errors still sets `Disconnected` state, so the health endpoint reflects reality during the approach to the threshold.

**Verdict**: Correct and complete. The threshold of 10 is reasonable for a Discord gateway (which can produce transient decoding errors on malformed events). If this needs tuning later, the const is easy to promote to config.

### BF-3: E2E Test Vector Gating (was MEDIUM)

**File**: `tests/e2e/agent-gateway-e2e.test.ts` lines 25-38

The `VECTORS_AVAILABLE` flag is a clean gate. The `SHOULD_SKIP` composition (`SKIP_E2E || !VECTORS_AVAILABLE`) is correct. One minor note: `SKIP_REASON` is computed on lines 27-31 but never referenced elsewhere in the file -- it is dead code. Not a functional issue, but worth cleaning up.

**Verdict**: Correct. The tests will not produce false failures in CI. The `TODO` comment on line 16 was also correctly simplified from `TODO(sprint-3)` to just `TODO`, since sprint references go stale.

### BF-4: CI Services (NATS + Redis) (was MEDIUM)

**File**: `.github/workflows/e2e-ci.yml`

Redis is added as a proper GitHub Actions service container with health checks. NATS is started via `docker run` with a manual polling loop (30 attempts, 1s apart). Both approaches are correct.

The verification step checks both NATS JetStream (`/jsz` endpoint) and Redis (`redis-cli ping`) before proceeding. The `|| (echo ... && exit 1)` pattern ensures a clear failure message if services are not ready after the wait.

One observation: NATS is not a service container because it requires JetStream flags (`-js`) that are harder to pass via the `services:` block's `options` field (which maps to `docker create` options, not entrypoint args). The `docker run` approach is the pragmatic choice.

**Verdict**: Correct and complete. The CI pipeline will now have the infrastructure the E2E tests require.

### BF-5: Token Field Rename (was MEDIUM) -- INTRODUCES BREAKING CHANGE

**File**: `apps/gateway/src/events/serialize.rs` line 136

The field was renamed from `"token"` to `"interaction_token"` in the JSON payload. The comment on lines 122-125 is well-written and explains the rationale (explicit naming to prevent accidental external logging of the response token).

**However**, the downstream consumer was not updated. In `apps/worker/src/consumers/CommandNatsConsumer.ts`:

- **Line 39**: The `InteractionPayload` interface still declares `token: string` in the `data` sub-object
- **Line 60**: The bridge function reads `payload.data.token` to populate `interactionToken`

After this rename ships, `payload.data.token` will be `undefined` (the field no longer exists in the serialized JSON), and the worker will be unable to reply to any Discord slash command. This is a **wire-format breaking change** that crosses the Rust/TypeScript boundary.

**Required fix**: Update `CommandNatsConsumer.ts` to match:
```typescript
// InteractionPayload.data (line 39)
interaction_token: string;  // was: token

// toDiscordEventPayload (line 60)
interactionToken: payload.data.interaction_token,  // was: payload.data.token
```

**Verdict**: Incomplete. The gateway-side rename is correct in isolation, but the consumer must be updated in the same commit/PR.

### BF-6: Guild Count Documentation (was MEDIUM)

**File**: `apps/gateway/src/shard/pool.rs` lines 215-216, 223

The added comments ("approximate", "non-atomic read-modify-write", "suitable for metrics/observability only, not authorization decisions") accurately describe the existing behavior. The `total_guilds()` call sums across all shards, and `set_guilds(shard_id, total + 1)` writes the *total* to a *per-shard* slot -- which is semantically wrong but works in practice because the health endpoint reads `total_guilds()` (summing all shards), and in a single-shard-per-task deployment the per-shard value *is* the total.

The comment correctly flags this as approximate. It prevents a future developer from depending on these counts for access control or billing.

**Verdict**: Correct. The underlying logic is still wrong (a pre-existing issue outside this diff's scope), but the documentation is honest about the limitation.

---

## New Issues Introduced

One new HIGH-severity finding was introduced by BF-5 (the token rename). No other new issues were introduced by the fixes in this iteration.

---

## Iteration Score

| Category | Score | Notes |
|----------|-------|-------|
| BF-1 (GuildCreate logging) | 10/10 | Clean fix |
| BF-2 (Circuit breaker) | 10/10 | Well-structured |
| BF-3 (E2E gating) | 9/10 | Dead `SKIP_REASON` variable |
| BF-4 (CI services) | 10/10 | Production-ready |
| BF-5 (Token rename) | 2/10 | Breaking change to downstream consumer |
| BF-6 (Guild count docs) | 10/10 | Honest documentation |
| **Overall** | **68/100** | Blocked by BF-5 consumer mismatch |

---

## Recommendations

1. **Blocking**: Update `CommandNatsConsumer.ts` to read `interaction_token` instead of `token`. Both the type definition (line 39) and the bridge function (line 60) must change.
2. **Non-blocking**: Remove the unused `SKIP_REASON` constant from `agent-gateway-e2e.test.ts`, or wire it into the test output so the skip reason is visible in CI logs.
3. **Future**: Consider promoting `MAX_CONSECUTIVE_ERRORS` to a runtime config value (env var) so it can be tuned without a rebuild.

---

<!-- BRIDGE_FINDINGS_START -->
```json
{
  "review_id": "BB60-iter2",
  "iteration": 2,
  "previous_score": 26,
  "current_score": 68,
  "findings": [
    {
      "id": "BB60-20",
      "severity": "HIGH",
      "category": "correctness",
      "title": "BF-5 token rename breaks downstream consumer",
      "file": "apps/worker/src/consumers/CommandNatsConsumer.ts",
      "lines": "39,60",
      "description": "The gateway now serializes the Discord response token as 'interaction_token' but CommandNatsConsumer still reads 'payload.data.token'. This wire-format mismatch will cause all slash command replies to fail (interactionToken = undefined).",
      "recommendation": "Update InteractionPayload.data.token to interaction_token (line 39) and payload.data.token to payload.data.interaction_token (line 60).",
      "effort": "XS",
      "status": "open"
    },
    {
      "id": "BB60-21",
      "severity": "LOW",
      "category": "maintainability",
      "title": "SKIP_REASON is computed but never used",
      "file": "tests/e2e/agent-gateway-e2e.test.ts",
      "lines": "27-31",
      "description": "The SKIP_REASON constant is built with conditional logic but is not referenced anywhere in the test file. This is dead code introduced by BF-3.",
      "recommendation": "Either remove SKIP_REASON or pass it to describe.skipIf as a second argument if Vitest supports skip reasons.",
      "effort": "XS",
      "status": "open"
    },
    {
      "id": "BB60-22",
      "severity": "PRAISE",
      "category": "reliability",
      "title": "Circuit breaker implementation is clean and well-instrumented",
      "file": "apps/gateway/src/shard/pool.rs",
      "lines": "155-182",
      "description": "The consecutive error counter with structured logging, proper reset on success, and integration with shard health state is textbook circuit breaker implementation. The const threshold and log fields make it easy to monitor and tune.",
      "recommendation": "No action needed. Consider promoting to env-var config in a future iteration.",
      "effort": "N/A",
      "status": "closed"
    },
    {
      "id": "BB60-23",
      "severity": "PRAISE",
      "category": "observability",
      "title": "GuildCreate serialization failure now visible",
      "file": "apps/gateway/src/events/serialize.rs",
      "lines": "51-55",
      "description": "The unwrap_or_else with tracing::warn ensures serialization failures are visible in logs while preserving graceful degradation. Structured fields (shard_id, error) make it alertable.",
      "recommendation": "No action needed.",
      "effort": "N/A",
      "status": "closed"
    },
    {
      "id": "BB60-24",
      "severity": "PRAISE",
      "category": "infrastructure",
      "title": "CI service setup is production-grade",
      "file": ".github/workflows/e2e-ci.yml",
      "lines": "17-63",
      "description": "Redis as a service container with health checks, NATS via docker run with JetStream flags and a polling health loop, and a final verification step before tests run. The approach correctly handles the NATS JetStream flag limitation in GitHub Actions service containers.",
      "recommendation": "No action needed.",
      "effort": "N/A",
      "status": "closed"
    },
    {
      "id": "BB60-25",
      "severity": "PRAISE",
      "category": "documentation",
      "title": "Guild count caveat is honest and preventive",
      "file": "apps/gateway/src/shard/pool.rs",
      "lines": "215-216,223",
      "description": "The comments explicitly state the count is approximate and unsuitable for authorization decisions, preventing a class of future bugs where someone might depend on this value for access control.",
      "recommendation": "No action needed.",
      "effort": "N/A",
      "status": "closed"
    }
  ],
  "summary": {
    "total": 6,
    "by_severity": {
      "HIGH": 1,
      "MEDIUM": 0,
      "LOW": 1,
      "PRAISE": 4
    },
    "open": 2,
    "closed": 4,
    "blocking_merge": true,
    "blocking_reason": "BB60-20: Wire-format mismatch between gateway and worker will break all slash command handling"
  }
}
```
<!-- BRIDGE_FINDINGS_END -->
