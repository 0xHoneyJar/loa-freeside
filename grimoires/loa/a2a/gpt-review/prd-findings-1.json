{
  "verdict": "CHANGES_REQUIRED",
  "summary": "This PRD targets the right launch blockers, but a few requirements conflict with the stated constraints and would likely leave CI/E2E non-reproducible or impossible to satisfy within this repo as written.",
  "blocking_issues": [
    {
      "location": "FR-1 / G-1 / Success Criteria #1 (E2E topology runs)",
      "issue": "Success criteria requires `docker compose ... up` to both start services and complete tests, but `up` alone does not run/complete an E2E test suite deterministically (it typically blocks and leaves services running).",
      "why_blocking": "Teams will “pass” the requirement by getting containers to start, while the actual goal (a repeatable E2E validation run with teardown and a pass/fail exit code) remains unmet; CI cannot rely on a blocking `up` command as the success signal.",
      "fix": "Change the canonical command to a deterministic runner, e.g. `docker compose -f ... up --build -d && ./tests/e2e/e2e-entrypoint.sh` or `docker compose -f ... run --rm e2e-runner` (preferred: add a dedicated `e2e-runner` service). Update AC-1.1 / Success Criteria #1 to require an exit code and teardown (`down -v`) and to specify where the tests execute (inside a container vs host)."
    },
    {
      "location": "FR-7 (CI E2E Pipeline) + NFR-2 (No New Dependencies) + FR-1 (compose includes `loa-finn-e2e` as stub or real via LOA_FINN_DIR)",
      "issue": "CI requirement implies building/running the full topology on PR, but the topology optionally depends on an external repo (`LOA_FINN_DIR`) and/or a stub; the PRD does not mandate which mode CI uses, nor guarantee the stub is sufficient for all E2E assertions.",
      "why_blocking": "If CI accidentally requires the external repo checkout, the requirement violates 'achievable within loa-freeside repo' and will be flaky/unbuildable on forks. If CI uses the stub but the tests implicitly expect real loa-finn behavior, E2E will fail or provide false confidence.",
      "fix": "Make CI mode explicit: CI must run against the in-repo stub only (no cross-repo checkout). Add an acceptance criterion that the compose file defaults to stub mode with zero extra inputs, and that `LOA_FINN_DIR` is an optional local-dev override only. If any tests require real loa-finn, move them to a separate, non-blocking workflow."
    },
    {
      "location": "FR-2 (Redis Test Isolation) + NFR-1 (Zero Regression) + NFR-4 (CI must be green)",
      "issue": "FR-2 allows either mocking Redis or conditionally skipping Redis-dependent tests, but NFR-1 forbids breaking existing tests and the PRD does not define which tests are allowed to be skipped vs must still run somewhere else.",
      "why_blocking": "A common failure mode is making `pnpm test` green by skipping large integration coverage, silently reducing regression protection; alternatively, trying to keep all tests running without Redis contradicts the stated problem (202 tests require Redis). Without a defined test taxonomy and where each class runs, CI will either stay red or become meaningless.",
      "fix": "Define a hard split: (a) `pnpm test` = unit-only, no external deps; (b) `pnpm test:integration` (or vitest project) = requires Redis; (c) CI runs both in separate jobs (unit always, integration optionally or on main/label). Update AC-2.2/2.3 to require that Redis-dependent tests still run in CI (just not in the default unit path), and specify the mechanism (vitest workspaces/projects + file globs)."
    },
    {
      "location": "FR-6 (Economic Loop E2E Validation) + FR-1 (Compose topology lists only 4 services: arrakis-e2e, redis-e2e, loa-finn-e2e, contract-validator)",
      "issue": "Economic loop tests mention x402 settlement and NOWPayments handler, but the compose topology described does not include any payment provider stub/service, and the PRD does not state how external payment flows are simulated to make the test deterministic.",
      "why_blocking": "If the billing full-loop test truly touches NOWPayments or any external network, E2E will be flaky or impossible in CI. If it doesn’t, the PRD is misrepresenting what is being validated, risking a false “economic loop validated” claim.",
      "fix": "Make the test’s dependencies explicit and fully in-compose: either (1) confirm `billing-full-loop.e2e.test.ts` uses only internal stubs (loa-finn stub + local settlement simulation) and does not call external providers, or (2) add an in-repo stub container for the payment provider endpoints (still consistent with 'no new services' only if it already exists; otherwise relax NFR-2 or re-scope FR-6). Update AC-6.2 to specify exactly which endpoints are exercised and that no external network calls occur in CI."
    },
    {
      "location": "FR-1 AC-1.3 (JWKS shared volume bootstrap) + FR-1 AC-1.4 (S2S JWT exchange succeeds)",
      "issue": "The PRD assumes a specific JWKS bootstrap direction (arrakis writes JWKS, loa-finn reads it) and a specific S2S JWT validation flow, but does not define the source of truth for keys (who is issuer, who hosts JWKS) or how rotation is handled in the compose run.",
      "why_blocking": "If the actual implementation expects the opposite (loa-finn hosts JWKS, arrakis fetches), the team will “fix” compose/tests in the wrong direction and break real integration. Key bootstrap mismatches are a classic E2E blocker that can consume the whole cycle.",
      "fix": "Anchor this to the contract/implementation reality: specify issuer/audience, which service hosts JWKS endpoint, and the exact discovery mechanism used in E2E (shared volume vs HTTP). Update AC-1.3/1.4 to match the real flow and include a concrete assertion (e.g., request signed by X validated by Y with kid=...)."
    },
    {
      "location": "FR-5 (Staging Deployment Checklist) + Goal G-5 ('deployable by following the steps')",
      "issue": "The checklist is required to enumerate 'every AWS Secrets Manager secret' and make staging 'deployable', but the PRD does not define the authoritative inventory source (Terraform outputs? naming convention? environments) or the minimum bar for 'deployable' given secrets are explicitly a human step and placeholders exist.",
      "why_blocking": "Without a defined inventory source, the checklist will drift immediately and miss a secret, causing staging deploy failure—the exact blocker this PRD is trying to remove. 'Deployable' is not measurable unless you define a verification step that can be executed.",
      "fix": "Define the inventory source and verification: e.g., 'Secrets list is derived from Terraform module X / variables in infrastructure/terraform/env/staging' and include a final step 'terraform plan/apply succeeds and service reaches /health 200'. If full deploy is out of scope, change the goal to 'checklist complete and validated against Terraform-defined secrets list'."
    }
  ],
  "question": "",
  "iteration": 1
}
