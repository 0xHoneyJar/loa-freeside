{
  "verdict": "CHANGES_REQUIRED",
  "summary": "This PRD is close, but it contains a few contradictions and missing production-critical definitions (auth boundaries, webhook exposure, and “private thread” feasibility) that could cause the team to build something that can’t launch or can’t be secured on ECS.",
  "blocking_issues": [
    {
      "location": "FR-0.3 (S2S JWT exchange) + Security section (S2S JWT ES256) + Infrastructure routing (ALB path/subdomain)",
      "issue": "Auth boundary between loa-freeside and loa-finn is underspecified and internally inconsistent for production: it says freeside signs ES256 JWT and finn validates via JWKS endpoint, but does not define who hosts JWKS, how keys rotate, and whether the call is internal-only (service-to-service) or public behind ALB.",
      "why_blocking": "If finn’s JWKS is public and finn is internet-facing, you risk exposing internal S2S auth surfaces and/or building a system where either (a) anyone can hit finn directly, bypassing freeside controls, or (b) freeside can’t reliably authenticate to finn due to missing key distribution/rotation design. This can block launch when you try to lock down networking on ECS/ALB.",
      "fix": "Define the production trust model explicitly: (1) Is loa-finn reachable only from loa-freeside via internal ALB / service discovery + security groups, or is it public? (2) Host JWKS at a stable URL owned by the issuer (typically loa-freeside), not the verifier; specify `iss`, `aud`, TTL, and rotation procedure. (3) Add an explicit requirement: finn must reject all requests not bearing a valid S2S JWT with correct `aud` and must not be directly callable by end users."
    },
    {
      "location": "Track 1A (Payments) FR-1.2 + Security (HMAC-SHA512 webhook verification) + Infrastructure section (ALB routing) + Existing assets (routes at /api/crypto/*)",
      "issue": "Webhook ingress is not defined for ECS/ALB: NOWPayments must reach a publicly accessible HTTPS endpoint, but the PRD doesn’t specify the exact externally routable URL, ALB listener rule, TLS termination, and whether the webhook hits loa-freeside or loa-finn. It also doesn’t specify idempotency keying source-of-truth (NOWPayments payment_id vs order_id) in acceptance criteria.",
      "why_blocking": "Payments are on the critical path (G-2). If the webhook endpoint isn’t concretely specified and exposed correctly through ALB/Route53 with stable URL + TLS, you can’t complete a real purchase. Ambiguous idempotency semantics can lead to double-minting credits (economic failure) or refusing legitimate retries (revenue loss).",
      "fix": "Add explicit production webhook contract: e.g. `POST https://api.{domain}/api/crypto/nowpayments/ipn` (or whatever route exists) served by loa-freeside behind ALB, with required headers/body, HMAC verification steps, and response codes. Define idempotency key: persist NOWPayments `payment_id` (and optionally `invoice_id`) with a unique constraint; acceptance criteria should include replay of identical webhook payload resulting in no additional credit lots."
    },
    {
      "location": "FR-3.1 (\"private to holder\" Discord thread) + User Journey (wallet verify → tier assigned) + Track 3 Discord requirements",
      "issue": "“Private to holder” Discord thread is likely not achievable as stated with standard Discord threads: private threads are limited and still require permissions; many servers can’t create truly holder-only threads without complex per-user permission overwrites and/or private thread eligibility constraints. The PRD doesn’t define the permission model or fallback behavior.",
      "why_blocking": "Discord is the primary Product A surface and on the critical path. If the team implements an impossible privacy model, they’ll either miss the launch window or ship something that violates user expectations (threads visible to others) and creates trust issues.",
      "fix": "Change requirement to an implementable Discord permission model: either (a) private thread where possible with explicit server prerequisites, else (b) public thread but with bot-enforced access controls and redaction, or (c) use per-holder private channels (heavier) or DMs (with limitations). Add acceptance criteria that specify exactly who can view/post and what happens when the server lacks private thread capability."
    },
    {
      "location": "Track 2 (Personality bridge) FR-2.1 vs stated architecture (\"route inference through per-NFT personality bridge\") + Dependency on loa-finn personality endpoint",
      "issue": "The PRD makes loa-freeside call loa-finn for personality (`GET /api/v1/nft/:tokenId/personality`) and then uses that to select pools and inject system prompts, but it also states the platform must “route inference through per-NFT personality bridge.” It’s unclear whether personality is owned by finn (inference engine) or freeside (platform layer), and where the authoritative mapping lives.",
      "why_blocking": "If you build personality ownership in the wrong service, you can end up with circular dependencies (freeside needs finn for personality; finn needs freeside for auth/budget) or duplicated logic that diverges. This can block integration in a 1–2 week window.",
      "fix": "Pick a single source of truth and document the call flow: Option 1 (recommended): freeside is the policy/orchestration layer—derives personality from NFT + config, then sends a signed inference request to finn including personality payload; finn treats personality as input, not something it serves. Option 2: finn owns personality derivation and freeside only passes tokenId; then remove FR-2.1 client lookup and instead require finn inference endpoint to return the chosen pool + personality metadata for auditability."
    },
    {
      "location": "Track 3 (Web chat widget) FR-3.6/FR-3.7 + Security (S2S JWT, API keys) + Token-gated access requirement in Product Context",
      "issue": "Web chat widget auth/gating is undefined: it claims an embeddable `<script>` with WebSocket streaming, but does not specify how token-gating is enforced for anonymous web users, how wallet verification happens, or how to prevent key leakage if using API keys in the browser.",
      "why_blocking": "A web widget without a defined auth model either can’t be shipped (no way to call inference securely) or will ship insecurely (publicly exposed credentials / bypassed gating), which is a launch-stopper given the stated security requirements and economic invariants.",
      "fix": "Define one viable MVP auth mode for the widget: (a) server-issued short-lived session token after SIWE wallet login, (b) Discord-linked session only (no anonymous), or (c) community-embedded widget uses a server-to-server key on the community backend (not in browser). Update FR-3.6 acceptance criteria to include the exact auth handshake and gating enforcement."
    },
    {
      "location": "Observability requirements FR-0.5–FR-0.7 + Infrastructure (Prometheus) + AWS ECS constraint",
      "issue": "Prometheus scraping is required but the PRD doesn’t specify where Prometheus runs in this AWS ECS stack (ECS task? AMP? EC2?) or how it reaches Fargate tasks (service discovery, target registration, auth).",
      "why_blocking": "G-3 requires alerts within 60s. If the monitoring architecture isn’t compatible with the existing Terraform/ECS setup, you can’t implement alerting in time and may discover too late that there is no Prometheus runtime or network path to scrape tasks.",
      "fix": "Bind the requirement to an actual AWS-supported approach present/allowed in the existing Terraform: either Amazon Managed Prometheus (AMP) with ADOT collector sidecars, or run Prometheus as an ECS service with Cloud Map discovery. Update FR-0.5 acceptance criteria to name the mechanism (AMP workspace + ADOT) and how targets are discovered."
    }
  ],
  "question": "",
  "iteration": 1
}
