{
  "verdict": "CHANGES_REQUIRED",
  "summary": "Kill switch middleware blocks all API key management endpoints, violating the requirement that existing keys continue to work when creation is disabled.",
  "issues": [
    {
      "severity": "major",
      "file": "api-keys.routes.ts",
      "line": 46,
      "description": "The feature flag kill switch is mounted at the router level, which disables listing/revoking existing keys. Requirement says only creation should be disabled while existing keys continue to work.",
      "current_code": "```typescript\n// Sprint 7 (320), Task 7.3: Feature flag kill switch\napiKeysRouter.use((_req, res, next) => {\n  const config = getConfig();\n  if (!config.features.apiKeysEnabled) {\n    res.status(503).json({\n      error: 'API key management not enabled',\n      message: 'Developer API key management is currently disabled',\n    });\n    return;\n  }\n  next();\n});\n\n// All key management endpoints require authentication and rate limiting\napiKeysRouter.use(memberRateLimiter);\napiKeysRouter.use(requireApiKeyAsync);\n```",
      "fixed_code": "```typescript\n// Sprint 7 (320), Task 7.3: Feature flag kill switch (creation only)\nconst requireApiKeysEnabled = (_req: AuthenticatedRequest, res: Response, next: () => void) => {\n  const config = getConfig();\n  if (!config.features.apiKeysEnabled) {\n    res.status(503).json({\n      error: 'API key management not enabled',\n      message: 'Developer API key management is currently disabled',\n    });\n    return;\n  }\n  next();\n};\n```\n```typescript\n// ---------------------------------------------------------------------------\n// POST /api/v1/keys — Create a new developer API key\n// ---------------------------------------------------------------------------\napiKeysRouter.post('/', requireApiKeysEnabled, memberRateLimiter, requireApiKeyAsync, async (req: AuthenticatedRequest, res: Response) => {\n  try {\n    const parsed = createKeySchema.safeParse(req.body);\n    if (!parsed.success) {\n      res.status(400).json({\n        error: 'Invalid request body',\n        details: parsed.error.issues.map(i => ({ path: i.path.join('.'), message: i.message })),\n      });\n      return;\n    }\n\n    const { name, mode, communityId, rateLimitRpm, rateLimitTpd } = parsed.data;\n\n    if (!req.adminName) {\n      res.status(401).json({ error: 'Unauthorized' });\n      return;\n    }\n    const userId = req.adminName;\n\n    const result = await createApiKey({\n      userId,\n      communityId,\n      name,\n      mode,\n      rateLimitRpm,\n      rateLimitTpd,\n    });\n\n    // Return cleartext exactly once — client must store it\n    res.status(201).json({\n      id: result.id,\n      key: result.cleartext,\n      keyPrefix: result.keyPrefix,\n      name: result.name,\n      mode: result.mode,\n      createdAt: result.createdAt,\n      warning: 'Store this key securely. It will not be shown again.',\n    });\n  } catch (err) {\n    if (err instanceof ApiKeyLimitError) {\n      res.status(409).json({ error: err.message });\n      return;\n    }\n    logger.error({ err }, 'Failed to create API key');\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n```\n```typescript\n// ---------------------------------------------------------------------------\n// GET /api/v1/keys — List active keys for the authenticated user\n// ---------------------------------------------------------------------------\napiKeysRouter.get('/', memberRateLimiter, requireApiKeyAsync, async (req: AuthenticatedRequest, res: Response) => {\n  try {\n    if (!req.adminName) {\n      res.status(401).json({ error: 'Unauthorized' });\n      return;\n    }\n    const userId = req.adminName;\n    const keys = await listApiKeys(userId);\n\n    // Only return non-sensitive fields (no key_hash, key_salt, etc.)\n    const safeKeys = keys.map(k => ({\n      id: k.id,\n      keyPrefix: k.keyPrefix,\n      name: k.name,\n      mode: k.mode,\n      rateLimitRpm: k.rateLimitRpm,\n      rateLimitTpd: k.rateLimitTpd,\n      lastUsedAt: k.lastUsedAt,\n      createdAt: k.createdAt,\n    }));\n\n    res.json({\n      keys: safeKeys,\n      count: safeKeys.length,\n    });\n  } catch (err) {\n    logger.error({ err }, 'Failed to list API keys');\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n```\n```typescript\n// ---------------------------------------------------------------------------\n// DELETE /api/v1/keys/:id — Revoke (soft-delete) an API key\n// ---------------------------------------------------------------------------\napiKeysRouter.delete('/:id', memberRateLimiter, requireApiKeyAsync, async (req: AuthenticatedRequest, res: Response) => {\n  try {\n    const parsed = keyIdParamSchema.safeParse(req.params);\n    if (!parsed.success) {\n      res.status(400).json({ error: 'Invalid key ID' });\n      return;\n    }\n\n    if (!req.adminName) {\n      res.status(401).json({ error: 'Unauthorized' });\n      return;\n    }\n    const userId = req.adminName;\n    const revoked = await revokeApiKey(parsed.data.id, userId);\n\n    if (!revoked) {\n      res.status(404).json({ error: 'Key not found or already revoked' });\n      return;\n    }\n\n    res.json({ revoked: true, id: parsed.data.id });\n  } catch (err) {\n    logger.error({ err }, 'Failed to revoke API key');\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n```\n```typescript\n// ---------------------------------------------------------------------------\n// POST /api/v1/keys/:id/rotate — Revoke old key, create new one\n// ---------------------------------------------------------------------------\napiKeysRouter.post('/:id/rotate', requireApiKeysEnabled, memberRateLimiter, requireApiKeyAsync, async (req: AuthenticatedRequest, res: Response) => {\n  try {\n    const parsed = keyIdParamSchema.safeParse(req.params);\n    if (!parsed.success) {\n      res.status(400).json({ error: 'Invalid key ID' });\n      return;\n    }\n\n    if (!req.adminName) {\n      res.status(401).json({ error: 'Unauthorized' });\n      return;\n    }\n    const userId = req.adminName;\n    const result = await rotateApiKey(parsed.data.id, userId);\n\n    if (!result) {\n      res.status(404).json({ error: 'Key not found or already revoked' });\n      return;\n    }\n\n    res.status(201).json({\n      id: result.id,\n      key: result.cleartext,\n      keyPrefix: result.keyPrefix,\n      name: result.name,\n      mode: result.mode,\n      createdAt: result.createdAt,\n      previousKeyId: parsed.data.id,\n      warning: 'Store this key securely. It will not be shown again.',\n    });\n  } catch (err) {\n    if (err instanceof ApiKeyLimitError) {\n      res.status(409).json({ error: err.message });\n      return;\n    }\n    logger.error({ err }, 'Failed to rotate API key');\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n```",
      "explanation": "The kill switch is now applied only to endpoints that create new keys (create/rotate), preserving access to existing keys (list/revoke) while ensuring the 503 response happens before auth for disabled features."
    }
  ],
  "fabrication_check": {
    "passed": true,
    "concerns": []
  },
  "iteration": 1
}
