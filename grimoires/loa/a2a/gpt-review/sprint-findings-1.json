{
  "verdict": "CHANGES_REQUIRED",
  "summary": "As written, the plan has migration ordering conflicts and a few missing/undefined components that will block implementation or make Phase 1A non-shippable without additional work.",
  "blocking_issues": [
    {
      "location": "Sprints 1–3 (migrations 042/043/046) + verification item #5",
      "issue": "Migration numbering/order is inconsistent: Sprint 2 introduces migration 046 before Sprint 3 introduces 043, while the requirements explicitly call out ordering like 042 → 043 → 044, etc.",
      "why_blocking": "If your repo enforces sequential migration application (common), applying 046 before 043 will fail CI/deploy or create divergent schema states across environments. It also violates the stated verification requirement, so the sprint cannot be considered “done” under its own constraints.",
      "fix": "Renumber/resequence migrations so they apply monotonically in the sprint order. Concretely: keep 042 in Sprint 1, move the revenue_rules referrer_bps change into 043 (or 042) and push referrer_earnings to 044, payout_system to 045, wallet_links to 046 (or similar). Update all sprint references and dependency diagram accordingly."
    },
    {
      "location": "Sprint 4.4 (bonus granting via CampaignAdapter) vs Phase 1A goal (non-withdrawable earnings)",
      "issue": "Sprint 4.4 depends on CampaignAdapter behavior and pool isolation for `referral:signup` being non-withdrawable, but there is no explicit task ensuring CampaignAdapter supports the new pool IDs and the “non-withdrawable” property end-to-end for these grants.",
      "why_blocking": "If CampaignAdapter/pool configuration doesn’t recognize `referral:signup` (and `score:rewards` later) or doesn’t enforce non-withdrawable semantics, bonus granting will either fail at runtime (unknown pool) or accidentally create withdrawable balances—breaking Phase 1A’s ship criterion.",
      "fix": "Add a Phase 1A task (Sprint 3 or 4) to: (a) register/seed the new pool IDs in whatever authoritative pool registry/config exists, (b) add an automated test proving CampaignAdapter grants into `referral:signup` are marked non-withdrawable and excluded from withdrawable queries, and (c) document/configure pool isolation rules."
    },
    {
      "location": "Sprint 6 (SettlementService + withdrawable balance) vs Phase 1A statement “Non-Withdrawable Earnings”",
      "issue": "Phase 1A is labeled non-withdrawable, but Sprint 6 introduces “settled withdrawable” and a withdrawable balance query, and Sprint 7’s lifecycle AC includes “48h settlement → withdrawable.” This contradicts the phase boundary and makes it unclear what ships in 1A.",
      "why_blocking": "Contradictory acceptance criteria will cause sprint failure because the team cannot verify completion: either earnings are non-withdrawable (as promised) or they become withdrawable after settlement (as tests/queries imply). This also affects Phase 1B dependency: payouts assume withdrawable balances exist.",
      "fix": "Decide and encode the rule in schema + queries + tests: For Phase 1A, either (Option A) settlement exists but lots remain non-withdrawable until Phase 1B flips a feature flag/pool classification, or (Option B) remove/disable withdrawable concepts from 1A and only compute “settled (non-withdrawable)” until Sprint 9. Update Sprint 6/7 ACs and naming accordingly (e.g., `settled_available_micro` vs `withdrawable`)."
    },
    {
      "location": "Sprint 4.4 (manual review queue) and Risk Mitigation table (manual review queue mentioned)",
      "issue": "Plan references “manual review queue” for flagged bonuses but no task defines where flagged items go, how they are surfaced, or how an admin resolves them (approve/deny) and what ledger/campaign actions occur on resolution.",
      "why_blocking": "Flagged/withheld bonuses will accumulate with no resolution path, which will break operationally and can block acceptance criteria like “flagged sent to review” (there’s no defined mechanism to test).",
      "fix": "Add a minimal Phase 1A task: persist flagged bonus review items (table or status fields), add an admin endpoint to list + resolve (approve→grant, deny→cancel), and add an integration test covering one flagged → approved flow and one flagged → denied flow."
    },
    {
      "location": "Sprint 13.3 (cleanup validation) vs missing implementation tasks",
      "issue": "Sprint 13.3 validates nonce cleanup cron and referral_events retention cleanup, but there are no earlier tasks that implement these cleanup crons/jobs.",
      "why_blocking": "You cannot validate scheduled cleanup that doesn’t exist; Sprint 13 will fail its own acceptance criteria or require unplanned work late in the cycle.",
      "fix": "Add explicit tasks (likely Sprint 11 for nonce cleanup; Sprint 4 or 7 for referral_events retention) to implement the BullMQ crons, including indexes/queries for efficient deletion, and unit/integration tests for expiry behavior."
    },
    {
      "location": "Sprint 8.1 (treasury account creation) + existing billing infrastructure assumptions",
      "issue": "Sprint 8.1 says “Treasury account creation” inside a migration, but doesn’t specify how this is done in SQLite migrations (pure SQL vs application-side seed) and how it remains idempotent across environments.",
      "why_blocking": "If your migration runner is SQL-only, “create account” may be impossible in that migration. If it’s app-seeded, missing idempotency can cause duplicate accounts or inconsistent entity IDs, breaking OCC and payout reserve accounting.",
      "fix": "Add a concrete, testable approach: either (a) SQL seed with deterministic primary key/entity_id and `INSERT ... ON CONFLICT DO NOTHING`, or (b) a post-migration seed step in code executed by the migration framework with an idempotency guard. Add an AC: running migrations twice yields exactly one treasury account with the expected entity_id."
    }
  ],
  "question": "",
  "iteration": 1
}
