{
  "verdict": "CHANGES_REQUIRED",
  "summary": "Net amount calculation can invert debits if amount_micro is already signed; normalize with ABS before applying polarity.",
  "issues": [
    {
      "severity": "major",
      "file": "migrations/0016_community_operations_view.sql",
      "line": 32,
      "description": "net_amount_micro applies a negative sign to debits without normalizing amount_micro; if debits are already stored as negative values (suggested by use of ABS elsewhere), this will flip the sign and inflate credits.",
      "current_code": "```sql\n    SUM(\n        CASE\n            WHEN le.entry_type IN ('credit', 'credit_back', 'governance_credit')\n                THEN le.amount_micro\n            WHEN le.entry_type IN ('debit', 'expiry', 'governance_debit')\n                THEN -le.amount_micro\n            ELSE 0\n        END\n    ) AS net_amount_micro,\n```",
      "fixed_code": "```sql\n    SUM(\n        CASE\n            WHEN le.entry_type IN ('credit', 'credit_back', 'governance_credit')\n                THEN ABS(le.amount_micro)\n            WHEN le.entry_type IN ('debit', 'expiry', 'governance_debit')\n                THEN -ABS(le.amount_micro)\n            ELSE 0\n        END\n    ) AS net_amount_micro,\n```",
      "explanation": "Using ABS() normalizes both positive and negative stored amounts, then applies the correct polarity based on entry_type to avoid sign inversion."
    }
  ],
  "fabrication_check": {
    "passed": true,
    "concerns": []
  },
  "iteration": 1
}
